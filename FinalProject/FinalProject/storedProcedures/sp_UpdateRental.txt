--sp_UpdateRental
--Ian Suddreth 8/1/2016

GO

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.ROUTINES WHERE SPECIFIC_NAME = 'sp_UpdateRental')
	DROP PROCEDURE sp_UpdateRental;

GO 

CREATE PROCEDURE sp_UpdateRental
    @RentalID smallint OUTPUT
  , @RentalCheckIn smalldatetime

AS 
BEGIN

	
	DECLARE @FolioID smallint
	DECLARE @BillingCategoryID smallint
	DECLARE @BIllingDescription char(30)
	DECLARE @BillingAmount smallmoney
	DECLARE @BillingItemQty tinyint
	DECLARE @BillingItemDate date

	UPDATE Rental SET RentalCheckIn = @RentalCheckIn WHERE RentalID = @RentalID

	SET @FolioID = (SELECT FolioID FROM Rental WHERE RentalID = @RentalID)
	SET @BillingCategoryID = 3
	SET @BIllingDescription = 'Book'
	SET @BillingAmount = (SELECT RentalTotal FROM Rental WHERE RentalID = @RentalID)
	SET @BillingItemQty = 1
	SET @BillingItemDate = CONVERT(date,GETDATE(),1)

	IF (SELECT RentalStatus FROM Rental WHERE RentalID = @RentalID) = 'C'
	BEGIN
		
		INSERT OPENQUERY (TITAN_SUDDRETH, 'SELECT FolioID, BillingCategoryID, BIllingDescription, BillingAmount, BillingItemQty, BillingItemDate FROM Billing')
		VALUES(@FolioID, @BillingCategoryID, @BIllingDescription, @BillingAmount, @BillingItemQty, @BillingItemDate)

	END
	RETURN
END